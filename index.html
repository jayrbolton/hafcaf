<head>
  <script type="text/javascript" src="monkeypatch.js"></script>
<style type="text/css">

  body {
    background: #222;
    font-family: Helvetica, Open Sans, sans-serif;
    color: white;
  }

</style></head>
<body>
  
  
  <div style="text-align: center;padding: 2rem;">

  <div style="font-size: 2.5rem;padding: 1rem;margin: 1rem;"><button style="background: #444;color: white;font-size: 2rem;padding: 1rem;border: 1px solid white;outline: none;cursor: pointer;" _add_caffeine_btn="">+ Record new caffeine consumption</button></div><div style="font-size: 2.5rem;padding: 1rem;">Current caffeine level:</div><div _total_mg="" style="font-size: 4rem;padding: 1rem;font-weight: bold;">4.991786388888889mg</div>

</div>


<script type="text/javascript" _custom_script="">(function() {
  window._state = localStorage.getItem('_state');
  function saveState() {
    localStorage.setItem("_state", JSON.stringify(window._state));
  }
  window._resetState = function () {
    window._state = {
      totalMg: 0,
      history: [],
    };
    localStorage.setItem("_state", JSON.stringify(window._state));
  }
  if (window._state) {
    try {
      window._state = JSON.parse(window._state);
    } catch(err) {
      console.error("Error loading state: " + err);
      throw err;
    }
  } else {
    window._resetState();
  }
  // Initialize the _total_mg component
  const totalMgEl = document.querySelector("[_total_mg]");
  function syncTotalMgEl () {
    totalMgEl.textContent = window._state.totalMg + "mg";
  }
  function consumeCaffeine(amount) {
    window._state.history.push({
      origAmount: amount,
      currentAmount: amount,
      time: Number(new Date()),
    });
    saveState();
    syncTotalMgEl();
  }
  function setTotalMg () {
    window._state.totalMg = window._state.history.reduce((sum, hist) => sum + hist.currentAmount, 0);
  }
  consumeCaffeine(window._state.totalMg);
  // Initialize the caffeine add button component
  const addCaffeineBtn = document.querySelector("[_add_caffeine_btn]");
  addCaffeineBtn.addEventListener('click', function (ev) {
    // Increment total mg by 5
    consumeCaffeine(5);
  });
  // Decrement caffeine level based on half-life
  setInterval(function () {
    // Given a half life of 5 hours, it degrades 0.001 every three minutes
    const threeMinutes = 60 * 3 * 1000; // 3 minutes in ms
    const fiveHrs = 60 * 60 * 5 * 1000; 
    window._state.history = window._state.history.map((hist) => {
      const diff = Number(new Date()) - hist.time;
      const reduction = 1- ( (0.5 * diff) / fiveHrs);
      hist.currentAmount = Math.round(hist.origAmount * reduction, 2);
      return hist;
    });
    setTotalMg();
    syncTotalMgEl();
  }, 3000);
})();</script></body>